<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SciText Digitizer (SVG)</title>

    <!-- External Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #111827;
        height: 100vh;
        overflow: hidden;
      }
      ::-webkit-scrollbar { width: 10px; height: 10px; }
      ::-webkit-scrollbar-track { background: #1f2937; }
      ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 5px; border: 2px solid #1f2937; }
      ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

      #canvas-wrapper {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        transition: width 0.15s ease-out;
      }
      
      .grid-overlay {
          background-size: 50px 50px;
          background-image:
            linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
          pointer-events: none;
      }

      .patch-highlight {
          stroke: #f97316; stroke-width: 2; fill: rgba(249, 115, 22, 0.05);
          opacity: 0; transition: opacity 0.15s; pointer-events: all;
      }
      .patch-highlight:hover { opacity: 1.0; cursor: pointer; }
      
      .patch-draft {
          fill: rgba(59, 130, 246, 0.1); stroke: #3b82f6; stroke-width: 2;
          stroke-dasharray: 8, 4; animation: dash 30s linear infinite;
          pointer-events: none;
      }
      @keyframes dash { to { stroke-dashoffset: -1000; } }

      #selection-box {
        border: 2px dashed #3b82f6; background-color: rgba(59, 130, 246, 0.1);
        position: absolute; pointer-events: none; display: none; z-index: 50;
      }

      .selection-frame {
          position: absolute; border: 1px solid #3b82f6;
          box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
          background-color: rgba(59, 130, 246, 0.05);
          cursor: move; z-index: 40; box-sizing: border-box;
      }

      .resize-handle {
          position: absolute; width: 10px; height: 10px;
          background-color: white; border: 2px solid #3b82f6;
          z-index: 50; border-radius: 2px; transition: transform 0.1s;
      }
      .resize-handle:hover { transform: scale(1.2); background-color: #eff6ff; }
      
      .handle-nw { top: -6px; left: -6px; cursor: nw-resize; }
      .handle-n  { top: -6px; left: 50%; margin-left: -5px; cursor: n-resize; }
      .handle-ne { top: -6px; right: -6px; cursor: ne-resize; }
      .handle-e  { top: 50%; right: -6px; margin-top: -5px; cursor: e-resize; }
      .handle-se { bottom: -6px; right: -6px; cursor: se-resize; }
      .handle-s  { bottom: -6px; left: 50%; margin-left: -5px; cursor: s-resize; }
      .handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
      .handle-w  { top: 50%; left: -6px; margin-top: -5px; cursor: w-resize; }

      #new-selection-action-bar {
        position: fixed; z-index: 100; display: none; animation: fadeIn 0.1s ease-out;
      }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

      .disabled-bar { opacity: 0.5; pointer-events: none; }
      .disabled-input { opacity: 0.5; pointer-events: none; background-color: #f9fafb; color: #9ca3af; }
      .tab-button { @apply px-4 py-2 text-sm font-semibold text-gray-500 border-b-2 border-transparent hover:text-gray-800 cursor-pointer transition; }
      .tab-button.active { @apply text-blue-600 border-blue-600 bg-white; }
      .editor-textarea { font-family: monospace; line-height: 1.5; resize: none; font-size: 11px; }
      .editor-textarea:focus { outline: none; background-color: #fff; box-shadow: inset 0 0 0 2px #bfdbfe; }
      input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
  </head>
  <body class="flex flex-col h-screen text-gray-800">
    
    <!-- HEADER -->
    <header class="bg-gray-800 text-white p-3 flex justify-between items-center shadow-lg z-30 shrink-0 border-b border-gray-900">
      <div class="flex items-center gap-4">
        <h1 class="text-xl font-bold tracking-wider mr-4 text-gray-100">SciText <span class="text-blue-400">Digitizer</span></h1>
        
        <div class="relative group">
          <input type="file" id="pdf-upload" accept="application/pdf, image/*" class="hidden" />
          <label for="pdf-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded text-sm font-semibold transition flex items-center gap-2 shadow-sm ring-1 ring-blue-400/20">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
            Load
          </label>
        </div>
        
        <div class="h-6 w-px bg-gray-600 mx-2"></div>

        <div id="pdf-zoom-controls" class="flex items-center bg-gray-700 rounded-md p-0.5 shadow-inner border border-gray-600">
          <button id="zoom-out" class="hover:bg-gray-600 hover:text-white text-gray-300 p-1 px-2 rounded-sm font-bold transition">-</button>
          <span id="zoom-level" class="text-xs font-mono w-14 text-center text-gray-200 select-none">100%</span>
          <button id="zoom-in" class="hover:bg-gray-600 hover:text-white text-gray-300 p-1 px-2 rounded-sm font-bold transition">+</button>
        </div>

        <div class="flex items-center gap-1 ml-2">
            <button id="btn-undo" class="text-gray-400 hover:text-white p-1 rounded disabled:opacity-30 transition" title="Undo"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg></button>
            <button id="btn-redo" class="text-gray-400 hover:text-white p-1 rounded disabled:opacity-30 transition" title="Redo"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 000 12h3" /></svg></button>
        </div>
      </div>
      
      <div class="flex items-center gap-4">
          <span id="ai-status" class="hidden text-blue-400 text-xs font-mono animate-pulse flex items-center gap-2">Processing...</span>
          <button id="fullscreen-toggle" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1.5 rounded text-xs font-semibold transition border border-gray-600">Full Screen</button>
      </div>
    </header>

    <main class="flex-1 flex flex-col overflow-hidden relative bg-white">
      <div class="flex bg-gray-50 border-b border-gray-200 shadow-sm shrink-0 z-20">
        <button id="tab-overlay" class="tab-button active">Compositor</button>
        <button id="tab-debug" class="tab-button">Debug View</button>
      </div>

      <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-50 text-gray-500">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center border border-gray-200">
            <h2 class="text-xl font-bold mb-2 text-gray-700">No Document Loaded</h2>
            <p class="text-sm text-gray-500">Upload a PDF or Image to begin.</p>
        </div>
      </div>
      
      <div id="pdf-loader" class="absolute inset-0 bg-gray-900 bg-opacity-70 flex flex-col items-center justify-center hidden z-50 backdrop-blur-sm">
          <div class="w-12 h-12 border-4 border-t-blue-500 border-gray-600 rounded-full animate-spin mb-4"></div>
          <span class="text-white font-bold tracking-wide text-lg">Loading...</span>
      </div>

      <div id="workspace-container" class="flex-1 flex overflow-hidden relative hidden">
          <div class="w-80 min-w-[320px] h-full flex flex-col border-r border-gray-200 bg-white z-10 shadow-xl">
              <div class="bg-gray-100 px-4 py-3 text-xs font-bold text-gray-600 border-b border-gray-200 flex flex-col gap-2">
                  <div class="flex justify-between items-center">
                      <span class="tracking-wide uppercase">Properties</span>
                      <div class="flex items-center gap-2">
                          <div class="flex bg-gray-200 rounded p-0.5 border border-gray-300">
                              <button id="mode-area" class="px-2 py-0.5 rounded text-[10px] font-bold transition bg-white shadow-sm text-blue-600">Area</button>
                              <button id="mode-content" class="px-2 py-0.5 rounded text-[10px] font-bold transition text-gray-500 hover:text-gray-700">Content</button>
                          </div>
                          <span id="patch-count" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-[10px] font-bold">0</span>
                      </div>
                  </div>
                  <div class="flex justify-between items-center border-t border-gray-200 pt-2 mt-1">
                      <span class="text-[10px] text-gray-400 font-normal">Actions:</span>
                      <div class="flex gap-2">
                           <button id="btn-fit-area" class="text-gray-600 hover:text-blue-600 flex items-center gap-1 bg-white border border-gray-300 px-2 py-0.5 rounded shadow-sm">Fit Area</button>
                           <button id="btn-fit-content" class="text-gray-600 hover:text-blue-600 flex items-center gap-1 bg-white border border-gray-300 px-2 py-0.5 rounded shadow-sm">Fill Content</button>
                      </div>
                  </div>
              </div>

              <div class="p-4 bg-gray-50 border-b border-gray-200 grid grid-cols-2 gap-3 text-xs select-none relative">
                  <div id="mode-label" class="absolute top-1 right-2 text-[9px] font-bold text-blue-400 uppercase tracking-widest pointer-events-none">Area Mode</div>
                  <div class="col-span-2 grid grid-cols-2 gap-3">
                      <div><label id="lbl-x" class="block text-gray-400 font-bold mb-1 uppercase text-[10px]">Pos X</label><input type="number" id="prop-x" class="w-full bg-white border border-gray-300 rounded p-1.5 focus:border-blue-500 focus:ring-1 outline-none font-mono text-gray-700" disabled></div>
                      <div><label id="lbl-y" class="block text-gray-400 font-bold mb-1 uppercase text-[10px]">Pos Y</label><input type="number" id="prop-y" class="w-full bg-white border border-gray-300 rounded p-1.5 focus:border-blue-500 focus:ring-1 outline-none font-mono text-gray-700" disabled></div>
                  </div>
                  <div class="col-span-2 grid grid-cols-2 gap-3">
                      <div><label id="lbl-w" class="block text-gray-400 font-bold mb-1 uppercase text-[10px]">Width</label><input type="number" id="prop-w" class="w-full bg-white border border-gray-300 rounded p-1.5 focus:border-blue-500 focus:ring-1 outline-none font-mono text-gray-700" disabled></div>
                      <div><label id="lbl-h" class="block text-gray-400 font-bold mb-1 uppercase text-[10px]">Height</label><input type="number" id="prop-h" class="w-full bg-white border border-gray-300 rounded p-1.5 focus:border-blue-500 focus:ring-1 outline-none font-mono text-gray-700" disabled></div>
                  </div>
              </div>
              
              <div class="px-4 py-2 text-xs font-bold text-gray-500 border-b bg-gray-100 flex justify-between items-center shadow-inner">
                  <span class="tracking-wide uppercase">SVG Source</span>
                  <span class="text-[10px] text-gray-400 font-normal">Auto-Updates</span>
              </div>
              <textarea id="code-editor" class="editor-textarea flex-1 p-4 text-gray-700 bg-white border-none outline-none text-xs" spellcheck="false" placeholder="Select a patch..."></textarea>
              
              <div class="p-3 border-t border-gray-200 bg-gray-50 flex flex-wrap gap-2 items-center justify-between">
                  <div class="flex gap-2">
                    <button id="btn-export" class="bg-white text-green-700 border border-green-300 hover:bg-green-50 px-3 py-1.5 rounded text-xs font-bold shadow-sm transition">Export</button>
                    <button id="btn-clear-all" class="text-red-500 hover:text-red-700 px-2 py-1.5 rounded text-xs font-medium transition">Reset</button>
                  </div>
                  <div id="context-actions" class="flex gap-2 disabled-bar transition-opacity duration-200">
                       <button id="btn-optimize" class="bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 px-3 py-1.5 rounded text-xs font-bold shadow-sm transition">Opt</button>
                       <button id="btn-regen" class="bg-blue-600 text-white border border-transparent hover:bg-blue-500 px-3 py-1.5 rounded text-xs font-bold shadow-sm transition">Regen</button>
                       <button id="btn-delete" class="bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 px-3 py-1.5 rounded text-xs font-semibold shadow-sm transition">Del</button>
                  </div>
              </div>
          </div>

          <div class="flex-1 h-full flex flex-col bg-gray-200 relative overflow-hidden">
              <div class="bg-white px-4 py-2 flex justify-center items-center gap-6 text-xs font-bold text-gray-600 border-b border-gray-300 shrink-0 shadow-sm z-20">
                   <label class="flex items-center gap-2 cursor-pointer hover:text-gray-900 group"><input type="checkbox" id="chk-source" checked class="rounded text-blue-600 focus:ring-blue-500"><span class="group-hover:text-blue-600">Source</span></label>
                   <div class="w-px h-4 bg-gray-300"></div>
                   <label class="flex items-center gap-2 cursor-pointer hover:text-gray-900 group"><input type="checkbox" id="chk-svg" checked class="rounded text-blue-600 focus:ring-blue-500"><span class="group-hover:text-blue-600">SVG Overlay</span></label>
                   <div class="w-px h-4 bg-gray-300"></div>
                   <label class="flex items-center gap-2 cursor-pointer hover:text-gray-900 group"><input type="checkbox" id="chk-grid" class="rounded text-blue-600 focus:ring-blue-500"><span class="group-hover:text-blue-600">Grid</span></label>
              </div>
              <div id="canvas-scroller" class="flex-1 overflow-auto flex justify-center p-12 relative cursor-default bg-gray-200">
                  <div id="canvas-wrapper" class="relative bg-white origin-top ring-1 ring-gray-900/5 transition-all ease-out duration-150">
                      <div id="pdf-layer" class="transition-opacity duration-200"></div> 
                      <div id="grid-layer" class="absolute inset-0 grid-overlay hidden opacity-50 pointer-events-none z-0"></div>
                      <div id="svg-layer" class="absolute inset-0 z-10 transition-opacity duration-200 pointer-events-none"></div> 
                      <div id="interaction-layer" class="absolute inset-0 z-20"></div>
                      <div id="selection-box"></div>
                  </div>
              </div>
          </div>
      </div>
      
      <div id="debug-container" class="flex-1 hidden flex-col bg-gray-900 p-6 overflow-auto text-white">
           <div class="flex justify-center gap-6 mb-6 h-80">
               <div class="border border-gray-700 bg-black p-3 rounded-lg flex flex-col items-center w-1/3 shadow-lg">
                   <span class="text-xs font-bold text-yellow-500 mb-2 uppercase tracking-wide">Source Crop</span>
                   <img id="debug-img-source" class="h-full object-contain bg-[#1a1a1a] rounded border border-gray-800">
               </div>
               <div class="border border-gray-700 bg-black p-3 rounded-lg flex flex-col items-center w-1/3 shadow-lg">
                   <span class="text-xs font-bold text-blue-400 mb-2 uppercase tracking-wide">SVG Result</span>
                   <div id="debug-svg-preview" class="h-full w-full flex items-center justify-center bg-white text-black rounded border border-gray-800"></div>
               </div>
           </div>
           <div class="flex-1 border border-gray-700 bg-gray-800 rounded-lg p-3 shadow-inner">
               <span class="text-xs font-bold text-gray-400 block mb-2 uppercase tracking-wide border-b border-gray-700 pb-1">System Log</span>
               <pre id="debug-log" class="text-xs font-mono text-green-400 overflow-auto h-full p-2"></pre>
           </div>
      </div>
    </main>

    <div id="new-selection-action-bar" class="bg-gray-800 text-white rounded-lg shadow-2xl flex items-center p-1.5 gap-2 border border-gray-600 ring-1 ring-black/50 backdrop-blur-md bg-opacity-95">
      <span class="text-[10px] font-bold text-gray-400 px-2 uppercase tracking-wider">Create:</span>
      <button class="px-3 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs font-bold text-white shadow-sm transition" onclick="app.createPatch('text')">Text</button>
      <button class="px-3 py-1 bg-amber-600 hover:bg-amber-500 rounded text-xs font-bold text-white shadow-sm transition" onclick="app.createPatch('image')">Image</button>
      <button class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-xs font-bold text-white shadow-sm transition" onclick="app.createPatch('empty')">Empty</button>
      <div class="w-px h-4 bg-gray-600 mx-1"></div>
      <button class="px-2 py-1 text-gray-400 hover:text-white text-xs font-medium transition" onclick="app.clearSelection()">Cancel</button>
    </div>
    
    <canvas id="processing-canvas" style="display:none;"></canvas>

    <script type="module">
        const CONFIG = { apiKey: "", defaultPdfUrl: "https://lsparrish.github.io/sciconvert/sample.png", aiScale: 2.0 };
        const state = {
            pdfDoc: null,
            scaleMultiplier: 1.0,
            baseWidth: 0,
            patches: [],
            activePatchId: null,
            aspectLocked: false,
            editMode: 'area', 
            history: [],
            historyIndex: -1,
            dragAction: null, 
            dragStart: { x: 0, y: 0 }, 
            initialRect: null, 
            initialScale: null,
            canvas: document.createElement('canvas'),
        };
        
        const els = {
            upload: document.getElementById('pdf-upload'),
            btnZoomIn: document.getElementById('zoom-in'),
            btnZoomOut: document.getElementById('zoom-out'),
            txtZoomLevel: document.getElementById('zoom-level'),
            btnUndo: document.getElementById('btn-undo'),
            btnRedo: document.getElementById('btn-redo'),
            workspace: document.getElementById('workspace-container'),
            emptyState: document.getElementById('empty-state'),
            loader: document.getElementById('pdf-loader'),
            wrapper: document.getElementById('canvas-wrapper'), 
            pdfLayer: document.getElementById('pdf-layer'),
            svgLayer: document.getElementById('svg-layer'),
            interactionLayer: document.getElementById('interaction-layer'),
            selectionBox: document.getElementById('selection-box'),
            selectionBar: document.getElementById('new-selection-action-bar'),
            editor: document.getElementById('code-editor'),
            patchCount: document.getElementById('patch-count'),
            contextActions: document.getElementById('context-actions'),
            aiStatus: document.getElementById('ai-status'),
            modeArea: document.getElementById('mode-area'),
            modeContent: document.getElementById('mode-content'),
            modeLabel: document.getElementById('mode-label'),
            btnFitArea: document.getElementById('btn-fit-area'),
            btnFitContent: document.getElementById('btn-fit-content'),
            lblX: document.getElementById('lbl-x'), lblY: document.getElementById('lbl-y'),
            lblW: document.getElementById('lbl-w'), lblH: document.getElementById('lbl-h'),
            propX: document.getElementById('prop-x'), propY: document.getElementById('prop-y'),
            propW: document.getElementById('prop-w'), propH: document.getElementById('prop-h'),
            chkSource: document.getElementById('chk-source'),
            chkSvg: document.getElementById('chk-svg'),
            chkGrid: document.getElementById('chk-grid'),
            debugContainer: document.getElementById('debug-container'),
            debugImg: document.getElementById('debug-img-source'),
            debugSvg: document.getElementById('debug-svg-preview'),
            debugLog: document.getElementById('debug-log')
        };

        // --- INIT & SETUP ---
        async function init() {
            try { 
                loadDefaultImage(); 
            } catch(e) { 
                console.error("Initialization Error:", e);
                els.loader.classList.add('hidden');
            }
            setupEventListeners();
            updateHistoryUI();
        }
        
        function loadDefaultImage() {
            els.loader.classList.remove('hidden');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                state.canvas.width = img.width;
                state.canvas.height = img.height;
                state.baseWidth = img.width;
                const ctx = state.canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                state.pdfDoc = { numPages: 1, isImage: true };
                renderPage();
                els.loader.classList.add('hidden');
                els.emptyState.classList.add('hidden');
                els.workspace.classList.remove('hidden');
                els.workspace.classList.add('flex');
                saveState(true);
                switchTab('overlay');
            };
            img.onerror = () => {
                console.error("Failed to load default image");
                els.loader.classList.add('hidden');
                alert("Could not load default image. Please upload a file.");
            };
            img.src = CONFIG.defaultPdfUrl;
        }
        
        function setupEventListeners() {
            els.interactionLayer.addEventListener('mousedown', handleMouseDown);
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
            window.addEventListener('keydown', handleKeyDown);

            els.btnZoomIn.onclick = () => setZoom(state.scaleMultiplier + 0.25);
            els.btnZoomOut.onclick = () => setZoom(state.scaleMultiplier - 0.25);
            els.btnUndo.onclick = undo;
            els.btnRedo.onclick = redo;
            
            els.modeArea.onclick = () => setMode('area');
            els.modeContent.onclick = () => setMode('content');
            els.btnFitContent.onclick = fitContentToArea;
            els.btnFitArea.onclick = fitAreaToContent;

            [els.propX, els.propY, els.propW, els.propH].forEach(input => {
                input.addEventListener('input', updatePatchFromInput);
                input.addEventListener('change', () => saveState());
            });
            
            els.editor.addEventListener('input', updatePatchFromEditor);
            els.editor.addEventListener('blur', () => saveState());

            els.chkSource.onchange = () => els.pdfLayer.style.opacity = els.chkSource.checked ? 1 : 0;
            els.chkSvg.onchange = () => els.svgLayer.style.opacity = els.chkSvg.checked ? 1 : 0;
            els.chkGrid.onchange = () => document.getElementById('grid-layer').classList.toggle('hidden', !els.chkGrid.checked);
            
            els.upload.onchange = handleFileUpload;
            
            document.getElementById('btn-export').onclick = exportSVG;
            document.getElementById('btn-clear-all').onclick = () => { if(confirm('Clear all?')) { state.patches = []; renderPatches(); saveState(); }};
            document.getElementById('btn-delete').onclick = () => { if(state.activePatchId) { state.patches = state.patches.filter(p => p.id !== state.activePatchId); deselect(); renderPatches(); saveState(); }};
            document.getElementById('btn-regen').onclick = () => { if(state.activePatchId) createPatch('text', state.activePatchId); };
            document.getElementById('btn-optimize').onclick = optimizeActivePatch;
            
            document.getElementById('tab-overlay').onclick = () => switchTab('overlay');
            document.getElementById('tab-debug').onclick = () => switchTab('debug');
            document.getElementById('fullscreen-toggle').onclick = () => document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen();
        }

        // --- MOUSE HANDLERS ---
        function handleMouseDown(e) {
            if(e.button !== 0) return;
            const target = e.target;
            
            if (target.dataset.action) {
                const frame = target.closest('.selection-frame');
                if (frame && frame.dataset.id && frame.dataset.id !== state.activePatchId) {
                    selectPatch(frame.dataset.id);
                    return; 
                }
                state.dragAction = target.dataset.action;
                state.dragStart = getLocalPos(e);
                
                const p = state.patches.find(x => x.id === state.activePatchId);
                if (p) {
                    p.scale = p.scale || {x: 1, y: 1}; p.offset = p.offset || {x: 0, y: 0};
                    state.initialRect = { ...p.rect }; 
                    state.initialScale = { ...p.scale };
                    updateUIProperties(p);
                }
                return;
            }
            
            els.interactionLayer.style.pointerEvents = 'none';
            const below = document.elementFromPoint(e.clientX, e.clientY);
            els.interactionLayer.style.pointerEvents = 'auto';
            
            if (below && below.classList.contains('patch-highlight')) {
                selectPatch(below.getAttribute('data-id'));
                return;
            }

            state.dragAction = 'create';
            state.dragStart = getLocalPos(e); 
            deselect(); 
            els.selectionBox.style.display = 'block';
            els.selectionBox.style.width = '0'; els.selectionBox.style.height = '0';
            els.selectionBar.style.display = 'none';
        }

        function handleMouseMove(e) {
            if (!state.dragAction) return;
            const cw = state.canvas.width; const ch = state.canvas.height;
            const pos = getLocalPos(e);

            if (state.dragAction === 'create') {
                const start = state.dragStart;
                const x = Math.min(pos.x, start.x); const y = Math.min(pos.y, start.y);
                const w = Math.abs(pos.x - start.x); const h = Math.abs(pos.y - start.y);
                const wrapRect = els.interactionLayer.getBoundingClientRect();
                const ratio = wrapRect.width / cw; 
                els.selectionBox.style.left = (x * ratio) + 'px'; 
                els.selectionBox.style.top = (y * ratio) + 'px';
                els.selectionBox.style.width = (w * ratio) + 'px'; 
                els.selectionBox.style.height = (h * ratio) + 'px';
            } else {
                const p = state.patches.find(x => x.id === state.activePatchId);
                if (!p || !state.initialRect) return;

                const dx = (pos.x - state.dragStart.x) / cw;
                const dy = (pos.y - state.dragStart.y) / ch;
                let newRect = { ...state.initialRect };
                let newScale = { ...p.scale }; 

                const action = state.dragAction;
                if (action === 'move') {
                    newRect.x += dx; newRect.y += dy;
                } else {
                    if (action.includes('e')) newRect.w = Math.max(0.001, state.initialRect.w + dx);
                    if (action.includes('s')) newRect.h = Math.max(0.001, state.initialRect.h + dy);
                    if (action.includes('w')) { 
                        const maxD = state.initialRect.w - 0.001;
                        const validDx = Math.min(maxD, dx);
                        newRect.x += validDx; newRect.w -= validDx; 
                    }
                    if (action.includes('n')) {
                        const maxD = state.initialRect.h - 0.001;
                        const validDy = Math.min(maxD, dy);
                        newRect.y += validDy; newRect.h -= validDy;
                    }
                }
                
                if (newRect.w > 0.005 && newRect.h > 0.005) {
                    p.rect = newRect;
                    p.scale = newScale;
                    updatePatchVisuals(p, cw, ch);
                    updatePropertyInputs();
                }
            }
        }

        function handleMouseUp(e) {
            if (!state.dragAction) return;
            
            if (state.dragAction === 'create') {
                 const sb = els.selectionBox;
                 if ((parseFloat(sb.style.width)||0) > 5) {
                     const rect = els.interactionLayer.getBoundingClientRect();
                     const ratio = state.canvas.width / rect.width;
                     const lx = parseFloat(sb.style.left) * ratio;
                     const ly = parseFloat(sb.style.top) * ratio;
                     const w = parseFloat(sb.style.width) * ratio;
                     const h = parseFloat(sb.style.height) * ratio;
                     
                     const newPatch = {
                         id: `p${Date.now()}`,
                         rect: { x: lx/state.canvas.width, y: ly/state.canvas.height, w: w/state.canvas.width, h: h/state.canvas.height },
                         bpDims: { w: w, h: h },
                         svgContent: '', 
                         scale: { x: 1, y: 1 }, offset: { x: 0, y: 0 },
                         status: 'draft'
                     };
                     state.patches.push(newPatch);
                     saveState();
                     selectPatch(newPatch.id); 
                 }
                 sb.style.display = 'none';
            } else {
                saveState();
            }
            state.dragAction = null;
            state.dragStart = null;
            state.initialRect = null;
        }
        
        function handleKeyDown(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); e.shiftKey ? redo() : undo(); return; }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); redo(); return; }
            if (e.key === 'Escape') {
                if (state.dragAction === 'create') { state.dragAction = null; els.selectionBox.style.display = 'none'; }
                else if (state.activePatchId) deselect();
                return;
            }
            if (!state.activePatchId) return;
            if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
            
            const p = state.patches.find(x => x.id === state.activePatchId);
            if (!p) return;
            
            const step = e.shiftKey ? 0.01 : 0.001;
            let handled = true;
            if (e.key === 'ArrowUp') p.rect.y -= step;
            else if (e.key === 'ArrowDown') p.rect.y += step;
            else if (e.key === 'ArrowLeft') p.rect.x -= step;
            else if (e.key === 'ArrowRight') p.rect.x += step;
            else if (e.key === 'Delete' || e.key === 'Backspace') {
                state.patches = state.patches.filter(x => x.id !== state.activePatchId);
                deselect(); saveState(); handled = true;
            } else handled = false;
            
            if (handled) { e.preventDefault(); renderPatches(); updatePropertyInputs(); }
        }

        // --- HISTORY & UTILS ---
        function saveState() {
            if (state.historyIndex < state.history.length - 1) state.history = state.history.slice(0, state.historyIndex + 1);
            state.history.push(JSON.parse(JSON.stringify(state.patches)));
            state.historyIndex++;
            if (state.history.length > 50) { state.history.shift(); state.historyIndex--; }
            updateHistoryUI();
        }
        function undo() { if (state.historyIndex > 0) { state.historyIndex--; restoreState(); } }
        function redo() { if (state.historyIndex < state.history.length - 1) { state.historyIndex++; restoreState(); } }
        function restoreState() { state.patches = JSON.parse(JSON.stringify(state.history[state.historyIndex])); deselect(); renderPatches(); updateHistoryUI(); }
        function updateHistoryUI() {
            els.btnUndo.disabled = state.historyIndex <= 0;
            els.btnUndo.classList.toggle('opacity-30', state.historyIndex <= 0);
            els.btnRedo.disabled = state.historyIndex >= state.history.length - 1;
            els.btnRedo.classList.toggle('opacity-30', state.historyIndex >= state.history.length - 1);
        }
        function setZoom(m) { state.scaleMultiplier = Math.max(0.25, Math.min(5.0, m)); applyZoom(); }
        function applyZoom() {
            const nw = state.baseWidth * state.scaleMultiplier;
            const nh = (state.canvas.height / state.canvas.width) * nw;
            els.wrapper.style.width = `${nw}px`; els.wrapper.style.height = `${nh}px`;
            els.txtZoomLevel.textContent = `${Math.round(state.scaleMultiplier * 100)}%`;
        }
        function renderPage() { els.pdfLayer.innerHTML = ''; els.pdfLayer.appendChild(state.canvas); state.canvas.style.width='100%'; state.canvas.style.height='100%'; applyZoom(); initSvgLayer(); }
        function initSvgLayer() {
            const w = state.canvas.width; const h = state.canvas.height;
            els.svgLayer.innerHTML = `<svg id="main-svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg"><g id="patches"></g><g id="highlights"></g></svg>`;
            renderPatches();
        }

        // --- AI & CORE LOGIC ---
        async function createPatch(type, id) {
            const tid = id || state.activePatchId; if(!tid) return;
            const p = state.patches.find(x => x.id === tid); if(!p) return;
            els.aiStatus.classList.remove('hidden'); els.selectionBar.style.display = 'none';
            
            const cw = state.canvas.width; const ch = state.canvas.height;
            const pw = Math.floor(p.rect.w * cw); const ph = Math.floor(p.rect.h * ch);
            const tmp = document.createElement('canvas'); tmp.width = pw * 2; tmp.height = ph * 2;
            tmp.getContext('2d').drawImage(state.canvas, p.rect.x * cw, p.rect.y * ch, pw, ph, 0, 0, pw*2, ph*2);
            
            try {
                // Local RLE Generation (Primary)
                const bpC = document.createElement('canvas'); 
                const MAX_BP = 300;
                let bpW = pw, bpH = ph;
                if (pw > MAX_BP || ph > MAX_BP) {
                    const ratio = Math.min(MAX_BP/pw, MAX_BP/ph);
                    bpW = Math.floor(pw*ratio); bpH = Math.floor(ph*ratio);
                }
                bpC.width = bpW; bpC.height = bpH;
                bpC.getContext('2d').drawImage(tmp, 0, 0, bpW, bpH);
                
                const rlePath = runLengthEncode(bpC.getContext('2d').getImageData(0,0,bpW,bpH));
                
                // Scale RLE back to 1x Patch coordinates
                const scaleX = pw / bpW;
                const scaleY = ph / bpH;
                
                // SVG Content
                p.svgContent = `<g transform="scale(${scaleX.toFixed(4)}, ${scaleY.toFixed(4)})"><path d="${rlePath}" fill="black" /></g>`;
                p.bpDims = {w: pw, h: ph};
                p.status = undefined; 
                p.scale = {x: 1, y: 1}; p.offset = {x: 0, y: 0};
                
                saveState(); selectPatch(p.id);
            } catch(e) { console.error(e); }
            els.aiStatus.classList.add('hidden');
        }

        function runLengthEncode(imgData) {
            let path = "";
            const { width, height, data } = imgData;
            for (let y = 0; y < height; y += 2) {
                let startX = -1;
                for (let x = 0; x < width; x++) {
                    const idx = (y * width + x) * 4;
                    const isDark = data[idx+3] > 128 && data[idx] < 128;
                    if (isDark) {
                        if (startX === -1) startX = x;
                    } else {
                        if (startX !== -1) {
                            path += `M${startX} ${y}h${x - startX}v2h-${x - startX}z`;
                            startX = -1;
                        }
                    }
                }
                if (startX !== -1) path += `M${startX} ${y}h${width - startX}v2h-${width - startX}z`;
            }
            return path;
        }

        function optimizeActivePatch() {
            if (!state.activePatchId) return;
            const p = state.patches.find(x => x.id === state.activePatchId);
            if (p && p.svgContent) {
                 // Mock optimization for brevity since regex-based merging is complex on raw paths
                 // Ideally this calls a robust path merger or text merger if AI was used.
                 console.log("Optimized.");
            }
        }

        function compressSVG(svgString) { return svgString.replace(/\s+/g, ' ').replace(/>\s*</g, '><').trim(); }

        // --- RENDERING & UI UPDATES ---
        function renderPatches() {
            const gPatches = els.svgLayer.querySelector('#patches');
            const gHighlights = els.svgLayer.querySelector('#highlights');
            gPatches.innerHTML = ''; gHighlights.innerHTML = '';
            
            if (!state.dragAction || state.dragAction === 'create') els.interactionLayer.innerHTML = '';
            
            const cw = state.canvas.width; const ch = state.canvas.height;
            
            state.patches.forEach(p => {
                p.scale = p.scale || {x:1, y:1}; p.offset = p.offset || {x:0, y:0};
                if (!p.bpDims) p.bpDims = { w: p.rect.w*cw, h: p.rect.h*ch };

                const px = p.rect.x * cw; const py = p.rect.y * ch;
                const pw = p.rect.w * cw; const ph = p.rect.h * ch;
                
                if (p.status === 'draft') {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", px); rect.setAttribute("y", py);
                    rect.setAttribute("width", pw); rect.setAttribute("height", ph);
                    rect.setAttribute("class", "patch-draft");
                    gPatches.appendChild(rect);
                } else {
                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svg.setAttribute("x", px); svg.setAttribute("y", py);
                    svg.setAttribute("width", pw); svg.setAttribute("height", ph);
                    svg.setAttribute("viewBox", `0 0 ${pw} ${ph}`);
                    svg.setAttribute("preserveAspectRatio", "none");
                    svg.setAttribute("id", `svg-patch-${p.id}`);
                    svg.innerHTML = `<g id="group-${p.id}" transform="translate(${p.offset.x}, ${p.offset.y}) scale(${p.scale.x}, ${p.scale.y})">${p.svgContent}</g>`;
                    gPatches.appendChild(svg);
                }
                
                if (p.id === state.activePatchId && !state.dragAction) renderActiveSelectionControls(p);
                else {
                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", px); rect.setAttribute("y", py);
                    rect.setAttribute("width", pw); rect.setAttribute("height", ph);
                    rect.setAttribute("class", "patch-highlight");
                    rect.setAttribute("data-id", p.id);
                    gHighlights.appendChild(rect);
                }
            });
            updateUI();
        }

        function renderActiveSelectionControls(patch) {
            if (document.querySelector(`.selection-frame[data-id="${patch.id}"]`)) return;
            const w = state.canvas.width; const h = state.canvas.height;
            const px = patch.rect.x * w; const py = patch.rect.y * h;
            const pw = patch.rect.w * w; const ph = patch.rect.h * h;

            const frame = document.createElement('div');
            frame.className = 'selection-frame'; frame.id = `frame-${patch.id}`;
            frame.style.left = `${px}px`; frame.style.top = `${py}px`;
            frame.style.width = `${pw}px`; frame.style.height = `${ph}px`;
            frame.dataset.id = patch.id; frame.dataset.action = 'move';

            ['nw', 'n', 'ne', 'e', 'se', 's', 'sw', 'w'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle handle-${pos}`;
                handle.dataset.action = pos;
                frame.appendChild(handle);
            });
            els.interactionLayer.appendChild(frame);
        }

        function selectPatch(id) {
            state.activePatchId = id;
            renderPatches();
            const p = state.patches.find(x => x.id === id);
            if(p) {
                els.editor.value = p.svgContent || '';
                updateUIProperties(p);
                if (p.status === 'draft') showCreationBar(p); else els.selectionBar.style.display = 'none';
            } else els.selectionBar.style.display = 'none';
        }
        
        function deselect() {
            state.activePatchId = null;
            renderPatches();
            els.selectionBar.style.display = 'none';
            els.selectionBox.style.display = 'none';
            els.editor.value = '';
            els.contextActions.classList.add('disabled-bar');
            [els.propX, els.propY, els.propW, els.propH].forEach(el => { el.value = ''; el.disabled = true; });
        }

        function updateUIProperties(p) {
            [els.propX, els.propY, els.propW, els.propH].forEach(el => { el.disabled = false; el.classList.remove('disabled-input'); });
            updatePropertyInputs();
            updateDebug(p);
        }

        function getLocalPos(e) {
            const r = els.interactionLayer.getBoundingClientRect();
            const sx = state.canvas.width / r.width;
            const sy = state.canvas.height / r.height;
            return { x: (e.clientX - r.left) * sx, y: (e.clientY - r.top) * sy };
        }
        
        function showCreationBar(p) {
             const rect = els.interactionLayer.getBoundingClientRect();
             const cw = state.canvas.width; const ch = state.canvas.height;
             const ratio = rect.width / cw; 
             const sx = rect.left + (p.rect.x * cw * ratio);
             const sy = rect.top + (p.rect.y * ch * ratio) + (p.rect.h * ch * ratio) + 10;
             els.selectionBar.style.left = Math.min(window.innerWidth - 250, Math.max(10, sx)) + 'px';
             els.selectionBar.style.top = sy + 'px';
             els.selectionBar.style.display = 'flex';
        }

        function updatePropertyInputs() {
            const p = state.patches.find(x => x.id === state.activePatchId);
            if(!p) return;
            const cw = state.canvas.width || 1000; const ch = state.canvas.height || 1000;
            
            if (state.editMode === 'area') {
                els.lblX.textContent = 'Pos X'; els.lblY.textContent = 'Pos Y';
                els.lblW.textContent = 'Width'; els.lblH.textContent = 'Height';
                els.propX.value = (p.rect.x * cw).toFixed(0);
                els.propY.value = (p.rect.y * ch).toFixed(0);
                els.propW.value = (p.rect.w * cw).toFixed(0);
                els.propH.value = (p.rect.h * ch).toFixed(0);
            } else {
                els.lblX.textContent = 'Shift X'; els.lblY.textContent = 'Shift Y';
                els.lblW.textContent = 'Eff. W'; els.lblH.textContent = 'Eff. H';
                els.propX.value = p.offset.x.toFixed(2);
                els.propY.value = p.offset.y.toFixed(2);
                els.propW.value = (p.bpDims.w * p.scale.x).toFixed(2);
                els.propH.value = (p.bpDims.h * p.scale.y).toFixed(2);
            }
        }
        
        function updateUI() {
            els.patchCount.textContent = `${state.patches.length}`;
            if(state.activePatchId) els.contextActions.classList.remove('disabled-bar');
            else els.contextActions.classList.add('disabled-bar');
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0]; if(!file) return;
            els.loader.classList.remove('hidden');
            if (file.type === 'application/pdf') {
                const ab = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(ab).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 2.0 });
                state.canvas.width = viewport.width; state.canvas.height = viewport.height; state.baseWidth = viewport.width;
                await page.render({ canvasContext: state.canvas.getContext('2d'), viewport }).promise;
            } else {
                const img = new Image(); img.src = URL.createObjectURL(file);
                await new Promise(r => img.onload = r);
                state.canvas.width = img.width; state.canvas.height = img.height; state.baseWidth = img.width;
                state.canvas.getContext('2d').drawImage(img, 0, 0);
            }
            state.patches = []; state.history = []; renderPage();
            els.loader.classList.add('hidden'); els.emptyState.classList.add('hidden');
            els.workspace.classList.remove('hidden'); els.workspace.classList.add('flex');
            saveState(true);
        }

        // --- GEOMETRY UTILS ---
        function fitContentToArea() {
            const p = state.patches.find(x => x.id === state.activePatchId);
            if (!p) return;
            const cw = state.canvas.width; const ch = state.canvas.height;
            const areaW = p.rect.w * cw; const areaH = p.rect.h * ch;
            if (!p.bpDims || !p.bpDims.w) p.bpDims = { w: areaW, h: areaH };
            p.offset = { x: 0, y: 0 };
            if (p.bpDims.w > 0) p.scale.x = areaW / p.bpDims.w;
            if (p.bpDims.h > 0) p.scale.y = areaH / p.bpDims.h;
            renderPatches(); updatePropertyInputs(); saveState();
        }

        function fitAreaToContent() {
            const p = state.patches.find(x => x.id === state.activePatchId);
            if (!p) return;
            const group = document.getElementById(`group-${p.id}`);
            if (!group) return;
            const rect = group.getBoundingClientRect();
            if (rect.width === 0) return;
            
            const wrapperRect = els.interactionLayer.getBoundingClientRect();
            const cw = state.canvas.width; const ch = state.canvas.height;
            const ratio = cw / wrapperRect.width; 
            
            const visX = (rect.left - wrapperRect.left) * ratio;
            const visY = (rect.top - wrapperRect.top) * ratio;
            const visW = rect.width * ratio;
            const visH = rect.height * ratio;
            
            p.rect = { x: visX/cw, y: visY/ch, w: visW/cw, h: visH/ch };
            p.offset = { x: 0, y: 0 }; 
            renderPatches(); updatePropertyInputs(); saveState();
        }

        function updatePatchFromInput() {
            const p = state.patches.find(x => x.id === state.activePatchId);
            if(!p) return;
            const cw = state.canvas.width; const ch = state.canvas.height;
            
            if (state.editMode === 'area') {
                p.rect.x = parseFloat(els.propX.value) / cw;
                p.rect.y = parseFloat(els.propY.value) / ch;
                p.rect.w = parseFloat(els.propW.value) / cw;
                p.rect.h = parseFloat(els.propH.value) / ch;
            } else {
                p.offset.x = parseFloat(els.propX.value) || 0;
                p.offset.y = parseFloat(els.propY.value) || 0;
                const targetW = parseFloat(els.propW.value);
                const targetH = parseFloat(els.propH.value);
                if (p.bpDims.w > 0) p.scale.x = targetW / p.bpDims.w;
                if (p.bpDims.h > 0) p.scale.y = targetH / p.bpDims.h;
            }
            updatePatchVisuals(p, cw, ch);
        }
        
        function updatePatchFromEditor() {
            const p = state.patches.find(x => x.id === state.activePatchId);
            if (p) {
                p.svgContent = els.editor.value;
                updatePatchVisuals(p, state.canvas.width, state.canvas.height);
            }
        }

        function updatePatchVisuals(p, cw, ch) {
            const frame = document.getElementById(`frame-${p.id}`);
            const nested = document.getElementById(`svg-patch-${p.id}`);
            
            if(frame) {
                frame.style.left = (p.rect.x * cw) + 'px'; frame.style.top = (p.rect.y * ch) + 'px';
                frame.style.width = (p.rect.w * cw) + 'px'; frame.style.height = (p.rect.h * ch) + 'px';
            }
            if(nested) {
                const pxW = p.rect.w * cw; const pxH = p.rect.h * ch;
                nested.setAttribute('x', p.rect.x * cw); nested.setAttribute('y', p.rect.y * ch);
                nested.setAttribute('width', pxW); nested.setAttribute('height', pxH);
                nested.setAttribute('viewBox', `0 0 ${pxW} ${pxH}`);
                
                const grp = document.getElementById(`group-${p.id}`);
                if (grp) {
                    grp.setAttribute('transform', `translate(${p.offset.x}, ${p.offset.y}) scale(${p.scale.x}, ${p.scale.y})`);
                    grp.innerHTML = p.svgContent;
                }
            }
        }

        // --- EXPORT & DEBUG ---
        function updateDebug(p) {
             els.debugSvg.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 ${p.bpDims.w} ${p.bpDims.h}" style="border:1px solid red">${p.svgContent}</svg>`;
             els.debugLog.textContent = JSON.stringify(p, null, 2);
        }
        
        function switchTab(t) {
             els.workspace.classList.toggle('hidden', t !== 'overlay');
             els.debugContainer.classList.toggle('hidden', t !== 'debug');
             els.debugContainer.classList.toggle('flex', t === 'debug');
             document.getElementById('tab-overlay').classList.toggle('active', t === 'overlay');
             document.getElementById('tab-debug').classList.toggle('active', t === 'debug');
        }
        
        function exportSVG() {
            const w = state.canvas.width; const h = state.canvas.height;
            let out = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><rect width="100%" height="100%" fill="white"/>`;
            state.patches.forEach(p => { if(!p.svgContent) return;
                out += `<svg x="${p.rect.x*w}" y="${p.rect.y*h}" width="${p.rect.w*w}" height="${p.rect.h*h}" viewBox="0 0 ${p.bpDims.w} ${p.bpDims.h}" preserveAspectRatio="none"><g transform="translate(${p.offset.x},${p.offset.y}) scale(${p.scale.x},${p.scale.y})">${p.svgContent}</g></svg>`;
            });
            out += `</svg>`;
            const url = URL.createObjectURL(new Blob([compressSVG(out)], {type: 'image/svg+xml'}));
            const a = document.createElement('a'); a.href = url; a.download = "scitext.svg"; a.click();
        }

        const setMode = (m) => {
            state.editMode = m;
            els.modeArea.className = m === 'area' ? 'px-2 py-0.5 rounded text-[10px] font-bold transition bg-white shadow-sm text-blue-600' : 'px-2 py-0.5 rounded text-[10px] font-bold transition text-gray-500 hover:text-gray-700';
            els.modeContent.className = m === 'content' ? 'px-2 py-0.5 rounded text-[10px] font-bold transition bg-white shadow-sm text-blue-600' : 'px-2 py-0.5 rounded text-[10px] font-bold transition text-gray-500 hover:text-gray-700';
            els.modeLabel.textContent = m === 'area' ? 'Area Mode' : 'Content Mode';
            els.modeLabel.className = m === 'area' ? 'absolute top-1 right-2 text-[9px] font-bold text-blue-400 uppercase tracking-widest pointer-events-none' : 'absolute top-1 right-2 text-[9px] font-bold text-amber-500 uppercase tracking-widest pointer-events-none';
            els.lblX.textContent = m === 'area' ? 'Pos X' : 'Shift X';
            els.lblY.textContent = m === 'area' ? 'Pos Y' : 'Shift Y';
            els.lblW.textContent = m === 'area' ? 'Width' : 'Eff. W';
            els.lblH.textContent = m === 'area' ? 'Height' : 'Eff. H';
            updatePropertyInputs();
        };

        window.app = { clearSelection: deselect, createPatch: createPatch };
        init();
    </script>
  </body>
</html>
