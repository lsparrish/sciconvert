<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SciText Digitizer (SVG)</title>

    <!-- PDF.js setup for worker loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>
    
    <!-- The head structure is now minimal, ready for CSS injection -->
  </head>
  <body>
    <!-- Structural content will be injected here by the module script -->

    <!-- SCRIPTS - Loading logic and application core -->
    <script src="https://lsparrish.github.io/sciconvert/src/scitext-helpers.js"></script>
    <script type="module">
        // Import the main application logic that manages state and events
        import { init, clearSelection, createRegion } from 'https://lsparrish.github.io/sciconvert/src/main.js';
        
        // Asynchronously load the template HTML and inject it into the body
        async function loadTemplateAndInitialize() {
            try {
                // 1. Fetch the raw HTML content from the template file
                const response = await fetch('https://lsparrish.github.io/sciconvert/src/template.html');
                const htmlText = await response.text();
                
                // 2. Parse the content to extract the CSS and structural body HTML
                const parser = new DOMParser();
                // We use DOMParser on the fetched text, which produces a Document object
                const doc = parser.parseFromString(htmlText, 'text/html');
                
                const styleElement = doc.querySelector('style');
                const structureDiv = doc.querySelector('#template-structure');
                
                if (styleElement && structureDiv) {
                    // 3. Inject Styles into the main document's head
                    document.head.appendChild(styleElement.cloneNode(true));
                    
                    // 4. Inject structural HTML into the main document's body
                    // We append the children of the structure div to the body
                    while (structureDiv.firstChild) {
                        document.body.appendChild(structureDiv.firstChild);
                    }
                    
                } else {
                    console.error("Template structure or styles not found in template.html. Check structureDiv or styleElement existence.");
                    document.body.innerHTML = '<h1>Error loading application template. Check console.</h1>';
                    return;
                }
                
                // 5. Initialize the application after injection
                window.app.init();
            } catch (error) {
                console.error("Failed to load or parse template.html:", error);
                document.body.innerHTML = '<h1>Critical Error: Failed to fetch application template.</h1>';
            }
        }
        
        // Expose the core functions to a mutable window.app object
        window.app = {
            init,
            clearSelection, 
            createRegion,   
        };

        // ---------------------------------------------------------------------
        // DEVELOPMENT OVERRIDE SECTION: Write new versions of functions here
        // These declarations will override the properties of the `window.app` object.
        // ---------------------------------------------------------------------
        
        // EXAMPLE OVERRIDE:
        //function testClearSelection() {
          //  console.log("Custom clearSelection called: I will only clear the UI locally.");
          //  // Optionally call the original function:
          //  // window.app.clearSelection(); 
        //}
        //window.app.clearSelection = testClearSelection;

        // ---------------------------------------------------------------------
        // END DEVELOPMENT OVERRIDE SECTION
        // ---------------------------------------------------------------------

        // Start the application after the DOM is ready and the template has loaded
        document.addEventListener('DOMContentLoaded', () => {
            loadTemplateAndInitialize();
        });
    </script>
  </body>
</html>
