<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SciText Digitizer (SVG)</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #e5e7eb;
        height: 100vh;
        overflow: hidden;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }

      /* Layout & Canvas */
      #pdf-render-container, #canvas-wrapper {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      
      /* Overlay SVG Elements */
      .patch-highlight {
          cursor: pointer;
          stroke: #f97316; /* Orange-500 */
          stroke-width: 2;
          fill: rgba(249, 115, 22, 0.01);
          opacity: 0; 
          transition: opacity 0.15s;
          pointer-events: all;
      }
      .patch-highlight:hover { opacity: 1.0; stroke-width: 3; }
      .patch-highlight.selected { stroke: #2563eb; opacity: 1.0; stroke-width: 3; fill: rgba(37, 99, 235, 0.1); }

      /* Selection Box */
      #selection-box {
        border: 2px dashed #2563eb;
        background-color: rgba(37, 99, 235, 0.1);
        position: absolute;
        pointer-events: none; 
        display: none;
        z-index: 50;
      }

      /* Action Bars */
      #new-selection-action-bar {
        position: fixed;
        z-index: 100;
        display: none;
        animation: fadeIn 0.1s ease-out;
      }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

      .disabled-bar { opacity: 0.5; pointer-events: none; }
      
      /* Tabs */
      .tab-button { @apply px-4 py-2 text-sm font-semibold text-gray-600 border-b-2 border-transparent hover:text-gray-900 cursor-pointer transition; }
      .tab-button.active { @apply text-blue-600 border-blue-600 bg-white; }

      .editor-textarea { font-family: monospace; line-height: 1.5; resize: none; }
    </style>
  </head>
  <body class="flex flex-col h-screen">
    
    <!-- HEADER -->
    <header class="bg-gray-800 text-white p-3 flex justify-between items-center shadow-md z-10 shrink-0">
      <div class="flex items-center gap-4">
        <h1 class="text-xl font-bold tracking-wider mr-4">SciText <span class="text-blue-400">Digitizer</span></h1>
        
        <!-- PDF Upload -->
        <div class="relative">
          <input type="file" id="pdf-upload" accept="application/pdf" class="hidden" />
          <label for="pdf-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-sm font-semibold transition flex items-center gap-2">
            Load PDF
          </label>
        </div>
        
        <!-- Navigation -->
        <div id="pdf-nav-controls" class="hidden flex items-center bg-gray-700 rounded px-2 py-1 gap-2">
          <button id="prev-page" class="hover:text-blue-300 p-1">&lt;</button>
          <span class="text-sm font-mono">Page <span id="page-num">0</span> / <span id="page-count">0</span></span>
          <button id="next-page" class="hover:text-blue-300 p-1">&gt;</button>
        </div>
        
        <!-- Zoom -->
        <div id="pdf-zoom-controls" class="hidden flex items-center bg-gray-700 rounded px-2 py-1 gap-2">
          <button id="zoom-out" class="hover:text-blue-300 p-1">-</button>
          <span id="zoom-level" class="text-xs font-mono w-12 text-center">100%</span>
          <button id="zoom-in" class="hover:text-blue-300 p-1">+</button>
        </div>
      </div>
      
      <div class="flex items-center gap-4">
          <span id="ai-status" class="hidden text-blue-400 text-xs font-mono animate-pulse">Processing...</span>
          <button id="fullscreen-toggle" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-sm font-semibold transition">Full Screen</button>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden relative bg-white">
      <!-- TABS -->
      <div class="flex bg-gray-50 border-b border-gray-200 shadow-inner shrink-0">
        <button id="tab-overlay" class="tab-button active">Compositor</button>
        <button id="tab-debug" class="tab-button">Debug View</button>
      </div>

      <!-- EMPTY STATE -->
      <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100 z-50 text-gray-500">
        <h2 class="text-2xl font-bold mb-2">No Document Loaded</h2>
        <p>Upload a PDF to begin.</p>
      </div>
      
      <!-- LOADER -->
      <div id="pdf-loader" class="absolute inset-0 bg-gray-800 bg-opacity-75 flex flex-col items-center justify-center hidden z-50">
          <div class="w-8 h-8 border-4 border-t-blue-500 border-gray-200 rounded-full animate-spin mb-2"></div>
          <span class="text-white font-semibold">Loading...</span>
      </div>

      <!-- WORKSPACE CONTAINER -->
      <div id="workspace-container" class="flex-1 flex overflow-hidden relative hidden">
          
          <!-- LEFT PANEL: Code / Tools -->
          <div class="w-1/3 h-full flex flex-col border-r border-gray-300 bg-white z-10 shadow-xl">
              <div class="bg-gray-100 px-4 py-2 text-xs font-bold text-gray-500 border-b flex justify-between">
                  <span id="panel-title">SVG OUTPUT</span>
                  <span id="patch-count" class="text-gray-400">0 Patches</span>
              </div>
              
              <!-- Main Editor (SVG Code) -->
              <textarea id="code-editor" class="editor-textarea flex-1 p-4 text-xs text-gray-800 bg-gray-50 border-none outline-none" readonly></textarea>
              
              <!-- Static Action Bar (Bottom Left) -->
              <div id="static-action-bar" class="p-2 border-t border-gray-200 bg-gray-50 flex flex-wrap gap-2">
                  <button id="btn-export" class="bg-green-100 text-green-700 border border-green-300 hover:bg-green-200 px-3 py-1 rounded text-xs font-semibold flex items-center gap-1">
                      <span>Export SVG</span>
                  </button>
                  <button id="btn-clear-all" class="bg-red-100 text-red-700 border border-red-300 hover:bg-red-200 px-3 py-1 rounded text-xs font-semibold flex items-center gap-1">
                      <span>Reset Page</span>
                  </button>
                  
                  <div class="w-px h-6 bg-gray-300 mx-1"></div>
                  
                  <!-- Contextual Actions (Only enabled when patch selected) -->
                  <div id="context-actions" class="flex gap-2 disabled-bar transition-opacity duration-200">
                       <button id="btn-regen" class="bg-blue-100 text-blue-700 border border-blue-300 hover:bg-blue-200 px-3 py-1 rounded text-xs font-semibold">Regenerate</button>
                       <button id="btn-delete" class="bg-gray-200 text-gray-700 border border-gray-300 hover:bg-gray-300 px-3 py-1 rounded text-xs font-semibold">Delete</button>
                  </div>
              </div>
          </div>

          <!-- RIGHT PANEL: Visual Canvas -->
          <div class="w-2/3 h-full flex flex-col bg-gray-500 relative">
              <!-- Canvas Toolbar -->
              <div class="bg-gray-200 p-2 flex justify-center gap-4 text-xs font-semibold text-gray-700 border-b border-gray-400 shrink-0 shadow-sm z-20">
                   <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="chk-source" checked class="rounded text-blue-600"> Source PDF</label>
                   <div class="w-px h-4 bg-gray-400"></div>
                   <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="chk-svg" checked class="rounded text-blue-600"> SVG Overlay</label>
              </div>
              
              <!-- Scrollable Canvas Wrapper -->
              <div id="canvas-scroller" class="flex-1 overflow-auto flex justify-center p-8 relative cursor-default">
                  <div id="canvas-wrapper" class="relative shadow-2xl bg-white origin-top">
                      <!-- 1. PDF Canvas Mount -->
                      <div id="pdf-layer" class="transition-opacity duration-200"></div> 
                      <!-- 2. SVG Patch Layer -->
                      <div id="svg-layer" class="absolute inset-0 z-10 transition-opacity duration-200 pointer-events-none"></div> 
                      <!-- 3. Interactive Selection Layer -->
                      <div id="interaction-layer" class="absolute inset-0 z-20 cursor-crosshair"></div>
                      
                      <!-- Visual Selection Box -->
                      <div id="selection-box"></div>
                  </div>
              </div>
          </div>
      </div>
      
      <!-- DEBUG VIEW (Hidden by default) -->
      <div id="debug-container" class="flex-1 hidden flex-col bg-gray-900 p-4 overflow-auto text-white">
           <div class="flex justify-center gap-4 mb-4 h-64">
               <div class="border border-gray-600 bg-black p-2 rounded flex flex-col items-center w-1/3">
                   <span class="text-xs font-bold text-yellow-400 mb-1">Source Crop</span>
                   <img id="debug-img-source" class="h-full object-contain bg-white">
               </div>
               <div class="border border-gray-600 bg-black p-2 rounded flex flex-col items-center w-1/3">
                   <span class="text-xs font-bold text-blue-400 mb-1">SVG Result</span>
                   <div id="debug-svg-preview" class="h-full w-full flex items-center justify-center bg-white text-black"></div>
               </div>
           </div>
           <div class="flex-1 border border-gray-700 bg-gray-800 rounded p-2">
               <span class="text-xs font-bold text-gray-400 block mb-1">Raw Response / Log</span>
               <pre id="debug-log" class="text-xs font-mono text-green-400 overflow-auto h-full"></pre>
           </div>
      </div>

    </main>

    <!-- FLOATING SELECTION BAR -->
    <div id="new-selection-action-bar" class="bg-gray-800 text-white rounded-lg shadow-2xl flex items-center p-1.5 gap-2 border border-gray-700">
      <button class="px-3 py-1 bg-blue-900/50 hover:bg-blue-800 rounded text-xs font-bold text-blue-200" onclick="app.createPatch('text')">Text</button>
      <button class="px-3 py-1 bg-amber-900/50 hover:bg-amber-800 rounded text-xs font-bold text-amber-200" onclick="app.createPatch('image')">Image</button>
      <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs font-bold text-gray-300" onclick="app.createPatch('empty')">Empty</button>
      <div class="w-px h-4 bg-gray-600"></div>
      <button class="px-2 py-1 hover:text-red-300 text-xs" onclick="app.clearSelection()">Cancel</button>
    </div>
    
    <!-- HIDDEN CANVAS for processing -->
    <canvas id="processing-canvas" style="display:none;"></canvas>

    <script type="module">
        /**
         * SciText Digitizer (Lean Version)
         * Focus: SVG Compositing Architecture
         */
        
        const CONFIG = {
            apiKey: "", // Runtime key provided by environment
            defaultPdfUrl: "https://lsparrish.github.io/sciconvert/sample.png",
            storageKey: "scitext_lean_v1",
            aiScale: 2.0, // High-res capture for AI
            maxRetries: 3
        };

        // --- APPLICATION STATE ---
        const state = {
            pdfDoc: null,
            pageNum: 1,
            scale: 1.2,
            patches: [], // Array of {id, rect, svgContent, bpDims}
            selection: null, // {x, y, w, h} percentages
            activePatchId: null,
            isSelecting: false,
            selectionStart: {x:0, y:0},
            canvas: document.createElement('canvas'), // Off-screen canvas for PDF rendering
        };
        
        // --- DOM ELEMENTS ---
        const els = {
            upload: document.getElementById('pdf-upload'),
            navControls: document.getElementById('pdf-nav-controls'),
            zoomControls: document.getElementById('pdf-zoom-controls'),
            pageNum: document.getElementById('page-num'),
            pageCount: document.getElementById('page-count'),
            
            workspace: document.getElementById('workspace-container'),
            emptyState: document.getElementById('empty-state'),
            loader: document.getElementById('pdf-loader'),
            
            // Fixed: Corrected ID to match HTML
            wrapper: document.getElementById('canvas-wrapper'), 
            pdfLayer: document.getElementById('pdf-layer'),
            svgLayer: document.getElementById('svg-layer'),
            interactionLayer: document.getElementById('interaction-layer'),
            selectionBox: document.getElementById('selection-box'),
            selectionBar: document.getElementById('new-selection-action-bar'),
            
            editor: document.getElementById('code-editor'),
            patchCount: document.getElementById('patch-count'),
            contextActions: document.getElementById('context-actions'),
            aiStatus: document.getElementById('ai-status'),
            
            chkSource: document.getElementById('chk-source'),
            chkSvg: document.getElementById('chk-svg'),
            
            // Debug
            debugContainer: document.getElementById('debug-container'),
            debugImg: document.getElementById('debug-img-source'),
            debugSvg: document.getElementById('debug-svg-preview'),
            debugLog: document.getElementById('debug-log')
        };

        // --- INIT ---
        async function init() {
            // Restore session or load default
            try {
                const saved = localStorage.getItem(CONFIG.storageKey);
                if(saved) {
                   const data = JSON.parse(saved);
                   // Simplified: In a real app, we'd restore the PDF from IndexedDB here.
                   // For this lean version, we'll default to loading the sample image to show functionality quickly.
                   loadDefaultImage(); 
                } else {
                   loadDefaultImage();
                }
            } catch(e) { loadDefaultImage(); }
            
            setupEventListeners();
        }
        
        function loadDefaultImage() {
            els.loader.classList.remove('hidden');
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                state.canvas.width = img.width;
                state.canvas.height = img.height;
                state.canvas.getContext('2d').drawImage(img, 0, 0);
                
                // Mock PDF state for single image
                state.pdfDoc = { numPages: 1, isImage: true };
                
                renderPage();
                els.loader.classList.add('hidden');
                els.emptyState.classList.add('hidden');
                els.workspace.classList.remove('hidden');
                els.workspace.classList.add('flex');
                
                // Switch tabs to Compositor
                switchTab('overlay');
            };
            img.src = CONFIG.defaultPdfUrl;
        }
        
        function renderPage() {
            // For the image version, we just mount the canvas
            els.pdfLayer.innerHTML = '';
            state.canvas.style.width = '100%';
            state.canvas.style.height = '100%';
            els.pdfLayer.appendChild(state.canvas);
            
            // Resize Wrapper
            els.wrapper.style.width = `${state.canvas.width}px`;
            els.wrapper.style.height = `${state.canvas.height}px`;
            
            // Init SVG Layer
            initSvgLayer();
        }

        // --- SVG LOGIC ---
        function initSvgLayer() {
            const w = state.canvas.width;
            const h = state.canvas.height;
            els.svgLayer.innerHTML = `<svg id="main-svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg"><g id="patches"></g><g id="highlights"></g></svg>`;
            renderPatches();
        }
        
        function renderPatches() {
            const svg = els.svgLayer.querySelector('svg');
            const gPatches = svg.querySelector('#patches');
            const gHighlights = svg.querySelector('#highlights');
            
            gPatches.innerHTML = '';
            gHighlights.innerHTML = '';
            
            const w = state.canvas.width; 
            const h = state.canvas.height;
            
            state.patches.forEach(p => {
                // 1. Visual Patch (Nested SVG)
                const px = p.rect.x * w;
                const py = p.rect.y * h;
                const pw = p.rect.w * w;
                const ph = p.rect.h * h;
                
                const nested = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                nested.setAttribute("x", px); nested.setAttribute("y", py);
                nested.setAttribute("width", pw); nested.setAttribute("height", ph);
                nested.setAttribute("viewBox", `0 0 ${p.bpDims.w} ${p.bpDims.h}`);
                nested.setAttribute("preserveAspectRatio", "none");
                nested.innerHTML = p.svgContent; // Inject raw content
                gPatches.appendChild(nested);
                
                // 2. Interaction Highlight (Invisible Rect on top)
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", px); rect.setAttribute("y", py);
                rect.setAttribute("width", pw); rect.setAttribute("height", ph);
                rect.setAttribute("class", "patch-highlight " + (p.id === state.activePatchId ? "selected" : ""));
                rect.setAttribute("data-id", p.id);
                // We append to the SVG layer visually, but interactions are actually handled by 
                // the interaction-layer DIV above it peeking through using document.elementFromPoint
                // or simply by replicating this rect in the interaction layer if needed.
                // For simplicity in this "Lean" version, we will let the SVG layer handle clicks via pointer-events:all on the class.
                gHighlights.appendChild(rect);
            });
            
            updateUI();
        }

        // --- INTERACTION ---
        function setupEventListeners() {
            const layer = els.interactionLayer;
            
            layer.addEventListener('mousedown', e => {
                if(e.button !== 0) return;
                
                // 1. Check for existing patch click (Peek through)
                layer.style.pointerEvents = 'none';
                const below = document.elementFromPoint(e.clientX, e.clientY);
                layer.style.pointerEvents = 'auto';
                
                if(below && below.classList.contains('patch-highlight')) {
                    const id = below.getAttribute('data-id');
                    selectPatch(id);
                    return;
                }
                
                // 2. Start Selection
                state.isSelecting = true;
                state.selectionStart = getLocalPos(e);
                deselect();
                
                els.selectionBox.style.display = 'block';
                els.selectionBox.style.width = '0'; els.selectionBox.style.height = '0';
                els.selectionBar.style.display = 'none';
            });
            
            layer.addEventListener('mousemove', e => {
                if(!state.isSelecting) return;
                const pos = getLocalPos(e);
                const x = Math.min(pos.x, state.selectionStart.x);
                const y = Math.min(pos.y, state.selectionStart.y);
                const w = Math.abs(pos.x - state.selectionStart.x);
                const h = Math.abs(pos.y - state.selectionStart.y);
                
                els.selectionBox.style.left = x + 'px'; els.selectionBox.style.top = y + 'px';
                els.selectionBox.style.width = w + 'px'; els.selectionBox.style.height = h + 'px';
            });
            
            layer.addEventListener('mouseup', e => {
                if(!state.isSelecting) return;
                state.isSelecting = false;
                
                const sb = els.selectionBox;
                const w = parseFloat(sb.style.width);
                const h = parseFloat(sb.style.height);
                
                if(w < 10 || h < 10) {
                    sb.style.display = 'none';
                    return;
                }
                
                // Finalize selection rect (percentages)
                const cw = state.canvas.width; const ch = state.canvas.height;
                const lx = parseFloat(sb.style.left); const ly = parseFloat(sb.style.top);
                
                state.selection = { x: lx/cw, y: ly/ch, w: w/cw, h: h/ch };
                
                // Show Bar
                const rect = layer.getBoundingClientRect();
                els.selectionBar.style.left = Math.min(window.innerWidth - 200, rect.left + lx) + 'px';
                els.selectionBar.style.top = (rect.top + ly + h + 10) + 'px';
                els.selectionBar.style.display = 'flex';
            });

            // UI Toggles
            els.chkSource.onchange = () => els.pdfLayer.style.opacity = els.chkSource.checked ? 1 : 0;
            els.chkSvg.onchange = () => els.svgLayer.style.opacity = els.chkSvg.checked ? 1 : 0;
            
            // Buttons
            document.getElementById('btn-export').onclick = exportSVG;
            document.getElementById('btn-clear-all').onclick = () => { if(confirm('Clear all?')) { state.patches = []; renderPatches(); }};
            document.getElementById('btn-delete').onclick = () => { 
                if(state.activePatchId) {
                    state.patches = state.patches.filter(p => p.id !== state.activePatchId);
                    deselect();
                    renderPatches();
                }
            };
            document.getElementById('btn-regen').onclick = () => {
                if(state.activePatchId) {
                    const p = state.patches.find(x => x.id === state.activePatchId);
                    if(p) { state.selection = p.rect; createPatch('text', p.id); }
                }
            };
            
            // Tabs
            document.getElementById('tab-overlay').onclick = () => switchTab('overlay');
            document.getElementById('tab-debug').onclick = () => switchTab('debug');
            document.getElementById('fullscreen-toggle').onclick = () => document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen();
        }
        
        // --- CORE LOGIC ---
        
        function getLocalPos(e) {
            const r = els.interactionLayer.getBoundingClientRect();
            return { x: e.clientX - r.left, y: e.clientY - r.top };
        }
        
        function selectPatch(id) {
            state.activePatchId = id;
            renderPatches(); // Re-renders to update highlight classes
            const p = state.patches.find(x => x.id === id);
            if(p) {
                els.editor.value = p.svgContent;
                updateDebug(p);
            }
        }
        
        function deselect() {
            state.activePatchId = null;
            renderPatches();
            els.selectionBar.style.display = 'none';
            els.selectionBox.style.display = 'none';
            els.editor.value = '';
            els.contextActions.classList.add('disabled-bar');
            state.selection = null;
        }
        
        function updateUI() {
            els.patchCount.textContent = `${state.patches.length} Patches`;
            if(state.activePatchId) els.contextActions.classList.remove('disabled-bar');
            else els.contextActions.classList.add('disabled-bar');
            
            // Auto-update editor with composite if no single patch selected
            if(!state.activePatchId) {
                els.editor.value = generateCompositeSVG();
            }
        }
        
        // --- AI OPERATIONS ---
        
        // Exposed to global scope for HTML onclick handlers
        window.app = {
            clearSelection: deselect,
            createPatch: createPatch
        };
        
        async function createPatch(type, existingId = null) {
            const sel = state.selection;
            if(!sel) return;
            
            els.aiStatus.classList.remove('hidden');
            els.selectionBar.style.display = 'none';
            
            // 1. Crop Image
            const cw = state.canvas.width; const ch = state.canvas.height;
            const px = Math.floor(sel.x * cw); const py = Math.floor(sel.y * ch);
            const pw = Math.floor(sel.w * cw); const ph = Math.floor(sel.h * ch);
            
            const tmp = document.createElement('canvas');
            tmp.width = pw * CONFIG.aiScale; 
            tmp.height = ph * CONFIG.aiScale;
            const ctx = tmp.getContext('2d');
            ctx.drawImage(state.canvas, px, py, pw, ph, 0, 0, tmp.width, tmp.height);
            const base64 = tmp.toDataURL('image/png').split(',')[1];
            
            // 2. Prepare Prompt
            const prompt = `Generate valid SVG code for the text/content in this image.
            - No markdown.
            - No <svg> wrapper, just the inner elements (<text>, <path>, etc).
            - Use font-size and fill="black".
            - ViewBox context is 0 0 ${tmp.width} ${tmp.height}.
            ${type === 'empty' ? 'Return empty string.' : ''}`;
            
            // 3. Call AI
            try {
                let svgContent = '';
                if(type !== 'empty') {
                    svgContent = await queryGemini(prompt, base64);
                    svgContent = svgContent.replace(/```svg/g, '').replace(/```/g, '').trim();
                }
                
                // 4. Save Patch
                const patch = {
                    id: existingId || `p${Date.now()}`,
                    rect: sel,
                    bpDims: { w: tmp.width, h: tmp.height },
                    svgContent: svgContent
                };
                
                const idx = state.patches.findIndex(x => x.id === patch.id);
                if(idx >= 0) state.patches[idx] = patch;
                else state.patches.push(patch);
                
                renderPatches();
                selectPatch(patch.id);
                
            } catch(e) {
                console.error(e);
                alert("AI Error: " + e.message);
            } finally {
                els.aiStatus.classList.add('hidden');
                els.selectionBox.style.display = 'none';
            }
        }
        
        async function queryGemini(text, imageB64) {
             const body = {
                 contents: [{
                     role: "user",
                     parts: [{ text: text }, { inlineData: { mimeType: "image/png", data: imageB64 } }]
                 }]
             };
             
             const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${CONFIG.apiKey}`, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(body)
             });
             
             if(!resp.ok) throw new Error(await resp.text());
             const json = await resp.json();
             return json.candidates[0].content.parts[0].text;
        }
        
        // --- EXPORT & UTILS ---
        
        function generateCompositeSVG() {
            const w = state.canvas.width; const h = state.canvas.height;
            let out = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">\n`;
            out += `<rect width="100%" height="100%" fill="white"/>\n`;
            state.patches.forEach(p => {
                const x = (p.rect.x * w).toFixed(2);
                const y = (p.rect.y * h).toFixed(2);
                const wid = (p.rect.w * w).toFixed(2);
                const hei = (p.rect.h * h).toFixed(2);
                out += `<svg x="${x}" y="${y}" width="${wid}" height="${hei}" viewBox="0 0 ${p.bpDims.w} ${p.bpDims.h}" preserveAspectRatio="none">${p.svgContent}</svg>\n`;
            });
            out += `</svg>`;
            return out;
        }
        
        function exportSVG() {
            const blob = new Blob([generateCompositeSVG()], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "scitext_export.svg";
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        
        function switchTab(t) {
             if(t === 'overlay') {
                 document.getElementById('workspace-container').classList.remove('hidden');
                 document.getElementById('debug-container').classList.add('hidden');
                 document.getElementById('tab-overlay').classList.add('active');
                 document.getElementById('tab-debug').classList.remove('active');
             } else {
                 document.getElementById('workspace-container').classList.add('hidden');
                 document.getElementById('debug-container').classList.remove('hidden');
                 document.getElementById('debug-container').classList.add('flex');
                 document.getElementById('tab-overlay').classList.remove('active');
                 document.getElementById('tab-debug').classList.add('active');
             }
        }
        
        function updateDebug(patch) {
             // Simple debug view population
             els.debugSvg.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 ${patch.bpDims.w} ${patch.bpDims.h}" style="border:1px solid red">${patch.svgContent}</svg>`;
             // Note: Source image crop would require re-extraction here, skipped for lean version
             els.debugLog.textContent = JSON.stringify(patch, null, 2);
        }

        // Start
        init();
    </script>
  </body>
</html>
